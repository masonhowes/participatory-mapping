<!DOCTYPE html>
<html>

<head>
    <title>Helpful School Resources - Mason Howes Portfolio</title>
    <link rel="icon" href="https://cdn.discordapp.com/attachments/1124233909991911456/1259043831811412009/m.png?ex=668a3f71&is=6688edf1&hm=73e5c40f049d95ac820259007142c648b21e22743717b46b7d19eda520a47043&">
    <script src="https://unpkg.com/maplibre-gl@3.1.0/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@3.1.0/dist/maplibre-gl.css" rel="stylesheet" />
    <!-- Styles for the map and popup -->
    <style>
        /* Basic CSS for the page */
        body {
            margin: 0;
            padding: 0;
        }

        /* Navigation Bar */
        .topnav {
            background-color: rgb(5, 56, 133);
            display: block;
            align-content: space-around;
            margin: -10px;
            height: 60px;
            border-bottom: 0px solid rgb(255, 213, 205);
            filter: drop-shadow(0px 0px 4px rgba(1, 1, 33, 0.202));
        }

        .logo {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 50px;
        }

        .logo img {
            height: 50px;
            margin-top: 12px;
        }

        .hamburgerMenu {
            font-size: 30px;
            cursor: pointer;
            padding-right: -10px;
            z-index: 6;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }
        
        #info {
            position: absolute;
            top: 0;
            left: 0;
            max-width: 350px;
            margin: 10px;
            margin-top: 60px;
            padding: 10px;
            padding-left: 20px;
            padding-right: 20px;
            background-color: #f4f5ff;
            border-radius: 5px;
            font-family: Arial, Helvetica, sans-serif;
            font-size: 12px;
            line-height: 1.5;
            color: rgb(13, 49, 102);
            z-index: 1;
        }
        
        #popup {
            padding: 10px;
        }

        #name {
            width: 100%;
            height: 20px;
            margin-bottom: 10px;
        }

        #email {
            width: 100%;
            height: 20px;
            margin-bottom: 10px;
        }

        #content {
            width: 100%;
            height: 45px;
            margin-bottom: 10px;
        }

        #submit {
            float: right;
        }

        
    </style>
</head>

<body>
    <!-- Map container -->
    <div id="map"></div>

    <div class="topnav" id="homePage">
        <div class="logo">
            <a class="active" href="https://masonhowes.github.io/Portfolio/index.html">
                <img src="https://cdn.discordapp.com/attachments/1124233909991911456/1259043831811412009/m.png?ex=668a3f71&is=6688edf1&hm=73e5c40f049d95ac820259007142c648b21e22743717b46b7d19eda520a47043&">
            </a>
        </div>
    </div>

    <!-- Information box -->
    <div id="info">
        <div class="hamburgerMenu" id="hamburgerMenu">
            &#9776;
        </div>
        <div class="infoContent" id="infoContent">
            <h3>Helpful School Resources Participatory Map</h3>
            <h4>Mason Howes | University of Washington </h4>
            <!-- Introduction to the participatory mapping solution -->
            <p>
                For a lot of students, the move to Seattle can be very difficult. You are away from home
                for the first time and in a new, urban environment. Even for those who have been in Seattle
                for a long time, there are many helpful resources available to those in need. Whether it's
                something like advising, school supplies, or even good study spots/places to eat, this map
                has it all! Check out all of the blue dots on the map to see what fellow students have
                deemed great, helpful resources! If you would like to make your own contribution, click on
                the map where your resource is located at, and fill in the fields that pop up.
                <br><br>
                
                Special thanks to Bo Zhao for assistance with creating this project.<br>
                <br><i>Zhao, Bo</i>, 2023, "Crafting Your Own Participatory Mapping Project: A Guide", https://doi.org/10.7910/DVN/VSND2H, <i>Harvard Dataverse</i>, V1<br><br>
                
                <i>Created: February 23rd, 2024</i><br>
                <i>Last update: July 5th, 2024</i>
            </p> 
        </div>
        
    </div>
    
    <!-- JavaScript code for the interactive map and data submission -->
    <script>
        const hamburgerMenu = document.getElementById('hamburgerMenu');
        const dropdownContent = document.getElementById('info');
        const dropdown = document.getElementById('infoContent');

        hamburgerMenu.addEventListener('click', function() {
            dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
        });

        // Variable to hold the popup instance
        let popup = null;
        
        // GeoJSON data object to store the contributed points
        let geojson = {
            'type': 'FeatureCollection',
            'features': []
        };
        
        // Create a new map instance
        let map = new maplibregl.Map({
            container: 'map', // container id
            style: 'https://api.maptiler.com/maps/streets-v2/style.json?key=Cusoe5zmfmn26glFoeoe', // style URL
            center: [-122.3321, 47.6062], // starting position [lng, lat]
            // pitch: 45, // pitch in degrees
            zoom: 12 // starting zoom
        });

        // Fetch existing records when the window is loaded
        window.addEventListener("load", async function () {
            let response = await fetch('https://mhowes-participatory-map-c289b6995dca.herokuapp.com/api/get-record', {
                method: 'GET'
            });

            let data = await response.json();
      
            // Iterate through the fetched records and add them to the GeoJSON data object
            for (let i = 0; i < data.rows.length; i++) {
                geojson.features.push({
                    'type': 'Feature',
                    'properties': {
                        'contributor': data.rows[i].contributor,
                        'email': data.rows[i].email,
                        'content': data.rows[i].content,
                    },
                    'geometry': {
                        'type': 'Point',
                        'coordinates': [data.rows[i].lng, data.rows[i].lat]
                    }
                });
            }
        });

        // After the map loads, add the GeoJSON source and layer for existing points
        map.on("load", function () {
            map.addSource('places', {
                'type': 'geojson',
                'data': geojson
            });

            map.addLayer({
                'id': 'placesLayer',
                'type': 'circle',
                'source': 'places',
                'paint': {
                    'circle-radius': 6,
                    'circle-color': '#3449EB'
                }
            });
        });

        // Show popup on mouse enter over an existing point
        map.on('mouseenter', 'placesLayer', function (e) {
            map.getCanvas().style.cursor = 'pointer';

            var coordinates = e.features[0].geometry.coordinates;
            var content = e.features[0].properties.content;
            var contributor = e.features[0].properties.contributor;

            popup = new maplibregl.Popup()
                .setLngLat(coordinates)
                .setHTML("<p><b>" + contributor + "</b> <i>said:</i> " + content + "</p>")
                .addTo(map);
        });

        // Remove popup on mouse leave from an existing point
        map.on('mouseleave', 'placesLayer', function () {
            map.getCanvas().style.cursor = '';
            popup.remove();
        });

        // Handle click event on the map to allow user contribution
        map.on('click', function (e) {
            if (popup) {
                popup.remove();
            }

            // Create the HTML content for the contribution popup
            const popupContent = '<div id="popup"><input type="text" id="name" placeholder="Input your name here..."><input type="text" id="email" placeholder="Input your email here..."><input type="text" id="content" placeholder="Input your message here..."><button id="submit">submit</button></div>';

            // Create a new popup and set its content
            popup = new maplibregl.Popup({ closeOnClick: false })
                .setLngLat(e.lngLat)
                .setHTML(popupContent)
                .addTo(map);

            // Attach an event listener to the submit button to handle new record submission
            document.getElementById('submit').addEventListener('click', submitNewRecord);
            e.preventDefault();
        });

        // Function to handle the submission of a new record
        async function submitNewRecord() {
            let contributor = document.getElementById('name').value;
            let email = document.getElementById('email').value;
            let content = document.getElementById('content').value;
            let lngLat = popup.getLngLat();

            // Create a new URLSearchParams object and append the data to it
            let newRecord = new URLSearchParams();
            newRecord.append('contributor', contributor);
            newRecord.append('email', email);
            newRecord.append('content', content);
            newRecord.append('lng', lngLat.lng);
            newRecord.append('lat', lngLat.lat);

            // Set the POST request settings
            let settings = {
                method: 'POST',
                body: newRecord
            }

            try {
                // Send the POST request to add the new record https://pmap-28a9a9408e2b.herokuapp.com/api/add-record
                await fetch('https://mhowes-participatory-map-c289b6995dca.herokuapp.com/api/add-record', settings);
            } catch (err) {
                // Handle any errors that occur during the request
                console.error(err);
            } finally {
                // Remove the popup and update the GeoJSON data with the new point
                popup.remove();
                geojson.features.push({
                    'type': 'Feature',
                    'properties': {
                        'contributor': contributor,
                        'email': email,
                        'content': content,
                    },
                    'geometry': {
                        'type': 'Point',
                        'coordinates': [lngLat.lng, lngLat.lat]
                    }
                });
                map.getSource('places').setData(geojson);
            }
        }
    </script>

</body>

</html>
